<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org">
<meta http-equiv="content-language" content="ru">
<head>
    <title>Личный кабинет</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="/css/all-page-style.css" rel="stylesheet">
</head>
<style>
    .custom-alert {
        position: fixed;
        top: 50px;
        left: 50%;
        transform: translateX(-50%);
        width: 400px;
        height: 75px;
        z-index: 1050;
        display: flex;
        align-items: center;
        justify-content: center;
        padding-right: 2rem;
        background-color: #d4edda; /* Background color for success alert */
        color: #155724; /* Text color for success alert */
        border-radius:16px;
    }

    .custom-alert .btn-close {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 0.75rem;
        padding: 0.2rem 0.4rem;
    }

    @keyframes fadeOut {
        from {
            opacity: 1;
        }
        to {
            opacity: 0;
        }
    }

    .fade-out {
        animation: fadeOut 1s forwards;
    }
</style>
<body>
<div th:replace="~{blocks/headerForPages :: headerForPages}"></div>

<main class="mt-5 container" style="max-width: 1500px">
    <div class="row">
        <div class="col-md-3">
            <div class="list-group">
                <a href="#profile" class="list-group-item list-group-item-action active" data-bs-toggle="list">Личный профиль</a>
                <a href="#booking" class="list-group-item list-group-item-action" data-bs-toggle="list">Брони</a>
                <a href="#settings" class="list-group-item list-group-item-action" data-bs-toggle="list">Настройки</a>
                <a href="/perform_logout" class="list-group item list-group-item-action text-center pb-2 pt-2" style="background-color: #d8e7d9">Выйти из учетной записи</a>
            </div>
        </div>
        <div class="col-md-9">
            <div class="tab-content">
                <div class="tab-pane fade show active" id="profile">
                    <h3 class="text-center">Профиль</h3>
                    <form th:action="@{/user-profile}" th:object="${user}" method="post">
                        <div class="mb-3">
                            <label for="surname" class="form-label">Фамилия</label>
                            <input type="text" class="form-control" id="surname" th:field="*{surname}">
                        </div>
                        <div class="mb-3">
                            <label for="name" class="form-label">Имя</label>
                            <input type="text" class="form-control" id="name" th:field="*{name}">
                        </div>
                        <div class="mb-3">
                            <label for="patronymic" class="form-label">Отчество</label>
                            <input type="text" class="form-control" id="patronymic" th:field="*{patronymic}">
                        </div>
                        <div class="mb-3">
                            <label for="phoneNumber" class="form-label">Телефон</label>
                            <input type="text" class="form-control" id="phoneNumber" th:field="*{phoneNumber}">
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Почта</label>
                            <input type="email" class="form-control" id="email" th:field="*{email}">
                        </div>
                        <button type="submit" class="btn btn-primary">Сохранить</button>
                    </form>
                </div>
                <div class="tab-pane fade" id="booking">
                    <h3 class="text-center">Брони</h3>
                    <div class="accordion" id="bookingAccordion">
                        <div th:each="booking : ${bookings}" class="mt-2">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading-${booking.id}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${booking.id}" aria-expanded="false" aria-controls="collapse-${booking.id}">
                                        Номер: <span th:text="${booking.rooms.roomType.title}"></span> &nbsp; Дата бронирования: <span th:text="${booking.bookingDate}"></span>
                                    </button>
                                </h2>
                                <div id="collapse-${booking.id}" class="accordion-collapse collapse" aria-labelledby="heading-${booking.id}" data-bs-parent="#bookingAccordion">
                                    <div class="accordion-body">
                                        <p>Дата заселения: <span th:text="${booking.checkInDate}"></span></p>
                                        <p>Дата выезда: <span th:text="${booking.departureDate}"></span></p>
                                        <p>Сумма бронирования: <span th:text="${booking.amount}"></span></p>
                                        <p>Тип бронирования: <span th:text="${booking.bookingType.type}"></span></p>
                                        <a th:href="@{/bookingInfo/{id}(id=${booking.id})}" class="btn btn-primary">Подробнее</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="settings">
                    <h3 class="text-center">Настройки</h3>
                    <form th:action="@{/edit-password}" method="post" onsubmit="return validatePassword()">
                        <div class="mb-3" id="passwordField">
                            <label for="oldPassword" class="form-label">Введите старый пароль</label>
                            <input type="password" class="form-control" id="oldPassword" name="oldPassword">
                        </div>
                        <div class="mb-3" id="newPasswordField">
                            <label for="newPassword" class="form-label">Введите новый пароль</label>
                            <input type="password" class="form-control" id="newPassword" name="newPassword">
                            <small id="passwordHelp" class="form-text text-danger"></small>
                        </div>
                        <div class="mb-3" id="newPasswordFieldCheck">
                            <label for="checkPassword" class="form-label">Повторите новый пароль</label>
                            <input type="password" class="form-control" id="checkPassword" name="checkPassword">
                        </div>
                        <button type="submit" class="btn btn-primary">Изменить пароль</button>
                    </form>
                    <button type="button" class="btn btn-danger mt-4" id="deleteProfileButton">Удалить профиль</button>
                </div>
            </div>
        </div>
    </div>
</main>
<div th:if="${successMessage}" id="alert" class="alert alert-success alert-dismissible fade show custom-alert" role="alert">
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    <div th:text="${successMessage}"></div>
</div>
<div th:replace="~{blocks/footer :: footer}"></div>

<!-- Подключение jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>

<!-- Подключение Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>

<!-- Подключение Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
<!-- jQuery Mask Plugin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var accordionItems = document.querySelectorAll('.accordion-item');

        accordionItems.forEach(function(item) {
            var button = item.querySelector('.accordion-button');

            button.addEventListener('click', function() {
                var collapseItem = item.querySelector('.accordion-collapse');

                if (collapseItem.classList.contains('show')) {
                    collapseItem.classList.remove('show');
                } else {
                    collapseItem.classList.add('show');
                }
            });
        });
    });
</script>
<script>
    $(document).ready(function() {
        $('#phoneNumber').mask('+7(000)000-00-00');
    });
</script>
<script>
    document.getElementById('deleteProfileButton').addEventListener('click', function() {
        if (confirm('Вы уверены, что хотите удалить профиль?')) {
            fetch('/delete-profile', { method: 'POST' })
                .then(response => response.text())
                .then(data => {
                    window.location.href = '/perform_logout';
                })
                .catch(error => console.error('Error:', error));
        }
    });
</script>
<script>
    function dismissAlert() {
        const alertElement = document.getElementById('alert');
        alertElement.classList.add('fade-out');
        setTimeout(() => {
            alertElement.remove();
        }, 1000); // Duration of fade-out animation
    }

    // Automatically dismiss the alert after 5 seconds if it exists
    document.addEventListener("DOMContentLoaded", function() {
        const alertElement = document.getElementById('alert');
        if (alertElement) {
            setTimeout(dismissAlert, 5000);
        }
    });
</script>
<script>
    function validatePassword() {
        var password = document.getElementById("newPassword").value;
        var passwordHelp = document.getElementById("passwordHelp");
        var regex = /^(?=.*[A-Z])(?=.*[!@#$%^&*()_\-+={}[\]|:;"'<>,.?/\\]).{8,}$/;

        if (!regex.test(password)) {
            passwordHelp.textContent = "Пароль должен содержать минимум 8 символов, одну заглавную букву и один специальный символ.";
            return false;
        }

        passwordHelp.textContent = "";
        return true;
    }
</script>
</body>
</html>
